Vagrant.configure("2") do |config|
  config.vm.box = "onlyoffice/base-debian13"
  config.vm.network "forwarded_port", guest: 22, host: 2222, auto_correct: true
  config.vm.hostname = "debian13-lab"
  config.ssh.insert_key = false

  # Fase 1: aggiornamento sistema e installazione pacchetti
  config.vm.provision "shell", inline: <<-SHELL
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y sudo openssh-server
  SHELL

  # Fase 2: configurazione SSH
  config.vm.provision "shell", inline: <<-SHELL
    mkdir -p /var/run/sshd
    mkdir -p /etc/ssh/sshd_config.d
    echo 'PermitRootLogin yes' > /etc/ssh/sshd_config.d/PermitRootLogin-custom.conf
    systemctl enable --now ssh || systemctl restart ssh || true
  SHELL

  # Fase 3: configurazione utenti
  config.vm.provision "shell", inline: <<-SHELL
    # Imposta password root
    echo 'root:root' | chpasswd

    # Crea utente studente con sudo NOPASSWD
    useradd -m -s /bin/bash studente
    echo 'studente:studente' | chpasswd
    usermod -aG sudo studente
    echo 'studente ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/studente-nopasswd
    chmod 440 /etc/sudoers.d/studente-nopasswd
  SHELL

  # Fase 4: pulizia
  config.vm.provision "shell", inline: <<-SHELL
    apt-get clean
    rm -rf /var/lib/apt/lists/*
  SHELL

  # Provider-specific (VirtualBox)
  config.vm.provider "virtualbox" do |vb|
    vb.memory = 1024
    vb.cpus = 1
    vb.gui = false
  end
end
