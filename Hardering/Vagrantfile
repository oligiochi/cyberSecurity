Vagrant.configure("2") do |config|
  # Box di base
  config.vm.box = "onlyoffice/base-debian13"
  
  # Porta SSH forward
  config.vm.network "forwarded_port", guest: 22, host: 2223, auto_correct: true
  config.vm.hostname = "debian13-lab"
  config.ssh.insert_key = false

  # ==========================
  # FASE 1: aggiornamento sistema e installazione pacchetti
  # ==========================
  config.vm.provision "shell", inline: <<-SHELL
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y sudo openssh-server vim bash-completion nmap
  SHELL

  # ==========================
  # FASE 2: configurazione SSH per root login via password
  # ==========================
  config.vm.provision "shell", inline: <<-SHELL
    mkdir -p /var/run/sshd
    mkdir -p /etc/ssh/sshd_config.d

    cat > /etc/ssh/sshd_config.d/PermitRootLogin-custom.conf <<'EOF'
PermitRootLogin yes
PasswordAuthentication yes
EOF

    # Riavvia SSH per applicare le modifiche
    systemctl enable ssh
    systemctl restart ssh
  SHELL

  # ==========================
  # FASE 3: creazione utenti
  # ==========================
  config.vm.provision "shell", inline: <<-SHELL
    # Imposta password root
    echo 'root:root' | chpasswd

    # Crea utente studente senza privilegi sudo globali
    useradd -m -s /bin/bash studente
    echo 'studente:studente' | chpasswd
  SHELL

  # ==========================
  # Provider VirtualBox
  # ==========================
  config.vm.provider "virtualbox" do |vb|
    vb.memory = 1024
    vb.cpus = 1
    vb.gui = false
  end
end
